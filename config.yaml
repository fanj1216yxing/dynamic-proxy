# 动态代理配置文件

# 代理列表URL（支持多种协议格式，纯字符串处理）
# 支持格式：
#   - 纯 ip:port           → 192.168.1.1:8080
#   - http://ip:port       鈫?http://1.2.3.4:80
#   - https://ip:port      鈫?https://5.6.7.8:443
#   - socks5://ip:port     鈫?socks5://9.10.11.12:1080
#   - socks4://ip:port     鈫?socks4://13.14.15.16:1080
proxy_list_urls:
  - "https://raw.githubusercontent.com/r00tee/Proxy-List/main/Socks5.txt"
  # 可以添加更多代理源（支持 http/https/socks4/socks5 协议）
  - "https://raw.githubusercontent.com/ClearProxy/checked-proxy-list/main/socks5/raw/all.txt"
  - "https://raw.githubusercontent.com/kssku/guaxue/main/data/proxies.yaml"
  - "https://raw.githubusercontent.com/waterbaizhang/tv/main/final.yaml"
  - "https://qybndbviblvt.us-west-1.clawcloudrun.com/api/v1/subscribe?token=u0bt57u81cui26g1vc&target=v2ray&list=true"
  - "https://raw.githubusercontent.com/nekosolo1233/p1oxy/main/v2.yaml"
  - "https://cdn.jsdelivr.net/gh/proxifly/free-proxy-list@main/proxies/all/data.txt"
  - "https://raw.githubusercontent.com/firefoxmmx2/v2rayshare_subcription/main/subscription/clash_sub.yaml"
  - "https://raw.githubusercontent.com/Q3dlaXpoaQ/V2rayN_Clash_Node_Getter/refs/heads/main/APIs/sc0.yaml"
  - "https://raw.githubusercontent.com/mahdibland/SSAggregator/master/sub/sub_merge_yaml.yml"
  - "https://raw.githubusercontent.com/snakem982/proxypool/main/source/clash-meta.yaml"
  - "https://raw.githubusercontent.com/chengaopan/AutoMergePublicNodes/master/list.yml"
  - "https://raw.githubusercontent.com/zhangkaiitugithub/passcro/main/speednodes.yaml"
  - "https://raw.githubusercontent.com/aiboboxx/v2rayfree/refs/heads/main/README.md"
  - "https://raw.githubusercontent.com/peasoft/NoMoreWalls/master/snippets/nodes.meta.yml"
  - "https://raw.githubusercontent.com/Ruk1ng001/freeSub/main/clash.yaml"
  - "https://raw.githubusercontent.com/SoliSpirit/v2ray-configs/main/all_configs.txt"
  - "https://raw.githubusercontent.com/ripaojiedian/freenode/main/clash"
  - "https://raw.githubusercontent.com/go4sharing/sub/main/sub.yaml"
  - "https://raw.githubusercontent.com/actionsfz/v2ray/refs/heads/master/all.yaml"
  - "https://raw.githubusercontent.com/Pawdroid/Free-servers/refs/heads/main/sub"
  - "https://raw.githubusercontent.com/acymz/AutoVPN/main/data/V2.txt"
  - "https://raw.githubusercontent.com/Barabama/FreeNodes/main/nodes/wenode.txt"
  - "https://raw.githubusercontent.com/Barabama/FreeNodes/main/nodes/v2rayshare.txt"
  - "https://raw.githubusercontent.com/Barabama/FreeNodes/main/nodes/nodefree.txt"
  - "https://raw.githubusercontent.com/Barabama/FreeNodes/main/nodes/ndnode.txt"
  - "https://raw.githubusercontent.com/Barabama/FreeNodes/main/nodes/clashmeta.txt"
  - "https://raw.githubusercontent.com/xiaoji235/airport-free/main/v2ray.txt"
  - "https://raw.githubusercontent.com/peasoft/NoMoreWalls/master/list.meta.yml"
  - "https://raw.githubusercontent.com/anaer/Sub/refs/heads/main/clash.yaml"
  - "https://raw.githubusercontent.com/free18/v2ray/refs/heads/main/c.yaml"
  - "https://raw.githubusercontent.com/peasoft/NoMoreWalls/master/list.yml"
  - "https://raw.githubusercontent.com/xiaoji235/airport-free/main/v2ray/v2rayshare.txt"
  - "https://raw.githubusercontent.com/xiaoji235/airport-free/main/clash/naidounode.txt"
  - "https://proxy.scdn.io/text.php"
  
  # - "https://example.com/http-proxies.txt"
  # - "https://example.com/socks4-proxies.txt"

# 特殊代理列表URL（复杂格式，支持额外文本描述）
# 使用简单正则自动提取 ip:port，忽略协议前缀和描述文本
# 例如：socks5://83.217.209.26:1 [[家宽] 英国 英格兰 纽伯里 [Vodafone Broadband]]
#       http://1.2.3.4:8080 [美国 纽约]
#       随便什么 192.168.1.1:8080 乱七八糟
special_proxy_list_urls:
  # - "https://example.com/complex-format-list.txt"
  # - "https://example.org/another-complex-list.txt"


# 是否为订阅抓取启用环境代理（读取 HTTP_PROXY/HTTPS_PROXY）
# 服务器直连外网可保持 false；受限网络可设为 true
subscription_use_env_proxy: false

# 订阅抓取代理（优先级高于 subscription_use_env_proxy）
# enabled=true 且 url 非空时，固定使用该代理；方便后续随时修改
# url 支持 http:// / https:// / socks5:// / socks5h://；也支持直接写 host:port（程序自动补 http://）
subscription_proxy:
  enabled: false
  url: "http://127.0.0.1:2081"

# 健康检查并发数（同时测试多少个代理）
health_check_concurrency: 2000

# 代理池更新间隔（分钟）
update_interval_minutes: 360

# 自动轮换间隔（分钟）
# 默认 30，填 now 表示每次请求都轮换一次代理
proxy_switch_interval_min: 30

# 单阶段健康检查超时设置（当 two-stage 关闭时生效）
health_check:
  # 总超时时间（秒）
  total_timeout_seconds: 8
  # TLS握手性能阈值（秒）
  tls_handshake_threshold_seconds: 4

# 两阶段健康检查（适合超大规模代理池）
health_check_two_stage:
  enabled: true
  # 第二阶段是否启用严格证书校验（影响 cert_verify 指标）
  strict_mode: true
  # 第一阶段：快速淘汰（仅建立隧道）
  stage_one:
    total_timeout_seconds: 6
    tls_handshake_threshold_seconds: 3
  # 第二阶段：真实站点验证（TLS/HTTP）
  stage_two:
    total_timeout_seconds: 20
    tls_handshake_threshold_seconds: 10

# 协议分级超时建议值：
# - http/https：快检档（stage1/stage2 建议都 5s）
# - ss/ssr/trojan：宽松档（stage1 10s，stage2 30~60s，握手阈值独立调优）
# - vmess：平衡档（stage1 6s，stage2 15s）
# - vless/hy2：高延迟放宽档（stage1 6s，stage2 30s）

# 协议级超时覆写（两阶段模型）
# 命中顺序：协议专用 > health_check_two_stage 对应 stage 默认值 > health_check 全局值
health_check_protocol_overrides:
  http:
    stage_one:
      total_timeout_seconds: 6
      tls_handshake_threshold_seconds: 6
    stage_two:
      total_timeout_seconds: 8
      tls_handshake_threshold_seconds: 8
  https:
    stage_one:
      total_timeout_seconds: 6
      tls_handshake_threshold_seconds: 6
    stage_two:
      total_timeout_seconds: 8
      tls_handshake_threshold_seconds: 8
  socks4:
    stage_one:
      total_timeout_seconds: 7
      tls_handshake_threshold_seconds: 7
    stage_two:
      total_timeout_seconds: 9
      tls_handshake_threshold_seconds: 9
  socks5:
    stage_one:
      total_timeout_seconds: 7
      tls_handshake_threshold_seconds: 7
    stage_two:
      total_timeout_seconds: 9
      tls_handshake_threshold_seconds: 9
  socks5h:
    stage_one:
      total_timeout_seconds: 7
      tls_handshake_threshold_seconds: 7
    stage_two:
      total_timeout_seconds: 9
      tls_handshake_threshold_seconds: 9
  ss:
    stage_one:
      total_timeout_seconds: 10
      tls_handshake_threshold_seconds: 6
    stage_two:
      total_timeout_seconds: 60
      tls_handshake_threshold_seconds: 20
  ssr:
    stage_one:
      total_timeout_seconds: 10
      tls_handshake_threshold_seconds: 6
    stage_two:
      total_timeout_seconds: 60
      tls_handshake_threshold_seconds: 20
  trojan:
    stage_one:
      total_timeout_seconds: 10
      tls_handshake_threshold_seconds: 6
    stage_two:
      total_timeout_seconds: 60
      tls_handshake_threshold_seconds: 20
  vmess:
    stage_one:
      total_timeout_seconds: 6
      tls_handshake_threshold_seconds: 3
    stage_two:
      total_timeout_seconds: 15
      tls_handshake_threshold_seconds: 8
  vless:
    stage_one:
      total_timeout_seconds: 6
      tls_handshake_threshold_seconds: 3
    stage_two:
      total_timeout_seconds: 30
      tls_handshake_threshold_seconds: 12
  hy2:
    stage_one:
      total_timeout_seconds: 6
      tls_handshake_threshold_seconds: 3
    stage_two:
      total_timeout_seconds: 30
      tls_handshake_threshold_seconds: 12

# 关键 TLS 参数补全策略（vless/trojan/hy2）
tls_param_policy:
  default_allow_insecure: false
  default_alpn: ["h2", "http/1.1"]

# cert_verify_failed 白名单（仅受控场景开放 insecure=true）
cert_verify_whitelist:
  enabled: false
  allowed_hosts: []
  require_insecure: true
  enforce_strict_audit: true

# HTTP Mainstream 混合入口降级策略
# fallback_http_socks: 主流协议池不可用时回退到 http/socks 池
# explicit_error: 主流协议池不可用时返回显式 503 错误（由业务自行处理）
mainstream_mixed:
  degrade_strategy: "explicit_error"
  explicit_error_message: "Mainstream upstream unavailable"

# 协议级 SLO（主流协议池）
protocol_slo:
  enabled: true
  min_healthy:
    vless: 1
    hy2: 1
    trojan: 1

# 告警策略
alerting:
  # 当 mainstream=0 连续超过该周期数时触发 P1 告警
  zero_mainstream_tolerance_cycles: 1

# 差异探测（黄金样本 + DNS 策略 + strict/relaxed A/B）
differential_probe:
  enabled: false
  target_url: "https://www.google.com"
  golden_sample_file: "golden-proxies.yaml"
  samples_per_protocol: 5
  compare_tls_policy: "relaxed" # client/server 对比时使用同一 TLS 策略: strict|relaxed
  report_output_file: "diff-probe-report.json"
  dns:
    mode: "system" # system | doh | dot
    doh_endpoint: "https://dns.google/resolve"
    dot_server: "1.1.1.1:853"

# 主流协议内核配置（用于 ss/ssr/trojan/vmess/vless/hy2 等拨号）
detector:
  core: "singbox" # 已部署核心示例: mihomo | meta | singbox

# 服务器端口配置
ports:
  socks5_strict: ":17283"
  socks5_relaxed: ":17284"
  http_strict: ":17285"
  http_relaxed: ":17286"
  http_mixed: ":17288"      # HTTP入口：仅自动选择 HTTP/HTTPS/SOCKS5 上游代理
  http_mainstream_mixed: ":17290" # HTTP入口：仅自动选择 VMESS/VLESS/HY2 等主流协议上游代理
  http_cf_mixed: ":17289"   # HTTP入口：自动选择可通过 CF 挑战的 HTTP/HTTPS/SOCKS5 上游代理
  rotate_control: ":17287" # 访问该端口会随机切换到一个新的健康代理

# 代理认证配置（可选）
# 如果启用，username/password 必须同时设置
auth:
  username: ""
  password: ""

# Cloudflare 挑战可通过性检测（可选）
cf_challenge_check:
  enabled: false
  # 建议填写你自己的 CF 保护页面，用于筛选可自动通过挑战的代理
  url: "https://linux.do"
  expected_statuses: [200]
  # 页面若包含以下关键词则判定为未通过挑战
  block_indicators:
    - "just a moment"
    - "cf-challenge"
    - "captcha"
  timeout_seconds: 12
