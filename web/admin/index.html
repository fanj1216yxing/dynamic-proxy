<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dynamic Proxy 管理台</title>
  <style>
    :root {
      --bg-1: #fff8fc;
      --bg-2: #ffeef6;
      --card: #ffffff;
      --line: #f7cddd;
      --text: #472b3a;
      --muted: #8f6a7d;
      --accent: #ff5f9f;
      --accent-strong: #ff2f85;
      --accent-soft: #ffe2ef;
      --ok: #20a464;
      --warn: #e09100;
      --danger: #d72667;
      --shadow: 0 14px 36px rgba(255, 65, 143, 0.12);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text);
      font-family: "Nunito", "Avenir Next", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background:
        radial-gradient(circle at 8% 8%, #fff4fa 0%, transparent 32%),
        radial-gradient(circle at 90% 18%, #ffd8e8 0%, transparent 30%),
        linear-gradient(145deg, var(--bg-1), var(--bg-2));
    }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      border-right: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.84);
      backdrop-filter: blur(10px);
      padding: 22px 14px;
    }

    .brand {
      font-size: 22px;
      font-weight: 800;
      color: var(--accent-strong);
      letter-spacing: 0.4px;
      margin: 2px 8px 18px;
    }

    .brand small {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0;
    }

    .nav-btn {
      width: 100%;
      border: 0;
      text-align: left;
      border-radius: 12px;
      padding: 11px 12px;
      margin: 6px 0;
      cursor: pointer;
      background: transparent;
      color: var(--text);
      font-weight: 700;
      transition: 0.16s ease;
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      transform: translateX(2px);
    }

    .side-tip {
      margin: 18px 8px 0;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed var(--line);
      background: #fff4fa;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .main {
      padding: 18px 20px 22px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 14px;
    }

    .top-title {
      margin: 0;
      font-size: 24px;
      color: var(--accent-strong);
      font-weight: 800;
    }

    .top-meta {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .auto-wrap {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
    }

    .auto-wrap select {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 4px 8px;
      background: #fff;
      color: var(--text);
      font-weight: 700;
      font-family: inherit;
    }

    .tab { display: none; }
    .tab.active { display: block; }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }

    .card .label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .2px;
    }

    .card .value {
      margin-top: 4px;
      font-size: 28px;
      line-height: 1.05;
      font-weight: 900;
      color: var(--accent-strong);
    }

    .card .sub {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .section {
      margin-top: 12px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 13px;
    }

    .section h2 {
      margin: 0 0 10px;
      color: var(--accent-strong);
      font-size: 17px;
      font-weight: 800;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #fff6fb;
      color: var(--text);
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 700;
    }

    .chip strong { color: var(--accent-strong); }
    .chip.warn { border-color: #ffd3a6; background: #fff7e9; color: #905d00; }
    .chip.ok { border-color: #b8efd2; background: #effdf6; color: #157547; }

    .funnel-row {
      margin: 10px 0;
      padding: 9px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff8fc;
    }

    .funnel-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 6px;
      color: var(--text);
    }

    .funnel-bars {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
    }

    .bar {
      height: 11px;
      min-width: 4px;
      border-radius: 999px;
    }

    .bar.input { background: #ffb7d4; }
    .bar.s1 { background: #ff7db3; }
    .bar.s2 { background: #ff2f85; }

    .funnel-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .filter-row,
    .action-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }

    input,
    select,
    textarea {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      background: #fff;
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }

    textarea { min-height: 130px; resize: vertical; width: 100%; }

    .btn {
      border: 0;
      border-radius: 11px;
      padding: 9px 12px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      font-weight: 800;
      transition: 0.16s ease;
      color: #fff;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
    }

    .btn:hover { transform: translateY(-1px); }

    .btn.soft {
      color: var(--accent-strong);
      background: #fff;
      border: 1px solid var(--line);
    }

    .btn.warn {
      color: #fff;
      background: linear-gradient(135deg, #ff9d4d, #ff7b00);
    }

    .btn.ghost {
      background: transparent;
      border: 1px dashed var(--line);
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 9px 6px;
      border-bottom: 1px solid #fde4ef;
      text-align: left;
      vertical-align: middle;
    }

    th {
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
    }

    tr:hover td { background: #fff5fa; }

    .tag {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 2px 8px;
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-size: 11px;
      font-weight: 800;
      white-space: nowrap;
    }

    .yes { color: var(--ok); font-weight: 800; }
    .no { color: var(--danger); font-weight: 800; }

    .pager {
      margin-top: 9px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    .pager-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pager-controls button {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
      padding: 5px 9px;
      cursor: pointer;
    }

    .pager-controls button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .muted { color: var(--muted); font-size: 12px; }

    pre {
      margin: 0;
      max-height: 360px;
      overflow: auto;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff6fa;
      color: #5d3349;
      font-size: 12px;
      line-height: 1.38;
      font-family: "Cascadia Mono", "Consolas", "Monaco", monospace;
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 1080px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { border-right: 0; border-bottom: 1px solid var(--line); }
      .card-grid { grid-template-columns: repeat(2, minmax(150px, 1fr)); }
      .split { grid-template-columns: 1fr; }
    }

    @media (max-width: 640px) {
      .main { padding: 14px 12px 18px; }
      .card-grid { grid-template-columns: 1fr; }
      .top-title { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">Proxy Candy<small>17233 管理中心</small></div>
      <button class="nav-btn active" data-tab="overview">总览仪表盘</button>
      <button class="nav-btn" data-tab="proxies">代理列表</button>
      <button class="nav-btn" data-tab="diagnostics">诊断中心</button>
      <button class="nav-btn" data-tab="actions">手动操作</button>
      <button class="nav-btn" data-tab="config">运行配置</button>
      <div class="side-tip">
        管理功能对齐 ZenProxy 的“可观测 + 可操作”思路，
        但保持你当前后端 API 语义。
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h1 class="top-title" id="pageTitle">总览仪表盘</h1>
          <div class="top-meta" id="syncLabel">最近同步: -</div>
        </div>
        <div class="auto-wrap">
          <label><input type="checkbox" id="autoRefresh" checked /> 自动刷新</label>
          <span>间隔</span>
          <select id="autoInterval">
            <option value="10">10s</option>
            <option value="20">20s</option>
            <option value="30" selected>30s</option>
            <option value="60">60s</option>
          </select>
          <button class="btn soft" id="btnReloadAll">立即刷新</button>
        </div>
      </div>

      <section class="tab active" id="tab-overview">
        <div class="card-grid" id="overviewCards"></div>

        <div class="section">
          <h2>协议健康分布</h2>
          <div class="chips" id="protocolChips"></div>
          <div class="muted" style="margin-top:8px;" id="sloText">SLO: -</div>
        </div>

        <div class="section">
          <h2>两阶段漏斗（按协议）</h2>
          <div id="funnelBox"></div>
        </div>
      </section>

      <section class="tab" id="tab-proxies">
        <div class="section">
          <h2>代理数据面板</h2>
          <div class="filter-row">
            <input id="fSearch" placeholder="搜索地址..." />
            <select id="fPool">
              <option value="">全部池</option>
              <option value="strict">strict</option>
              <option value="relaxed">relaxed</option>
              <option value="cf">cf</option>
              <option value="mixed">mixed</option>
              <option value="mainstream">mainstream</option>
              <option value="cf_mixed">cf_mixed</option>
            </select>
            <select id="fProto"><option value="">全部协议</option></select>
            <select id="fCurrent">
              <option value="">全部状态</option>
              <option value="current">仅当前生效</option>
              <option value="non_current">仅非当前</option>
            </select>
            <select id="fPageSize">
              <option value="20">20/页</option>
              <option value="50" selected>50/页</option>
              <option value="100">100/页</option>
            </select>
          </div>

          <table>
            <thead>
              <tr>
                <th data-sort="address">地址</th>
                <th data-sort="protocol">协议</th>
                <th data-sort="pool">池</th>
                <th data-sort="latency_ms">延迟</th>
                <th data-sort="current">当前</th>
              </tr>
            </thead>
            <tbody id="proxyTbody"></tbody>
          </table>

          <div class="pager">
            <div id="proxySummary">共 0 条</div>
            <div class="pager-controls">
              <button id="prevPage">上一页</button>
              <span id="pageInfo">1 / 1</span>
              <button id="nextPage">下一页</button>
            </div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-diagnostics">
        <div class="section">
          <h2>检测错误码分布</h2>
          <div class="action-row">
            <button class="btn soft" id="btnLoadMetrics">刷新 Metrics</button>
          </div>
          <div class="chips" id="errorCodeChips"></div>
        </div>

        <div class="section">
          <h2>差异探测（Diff Probe）</h2>
          <div class="action-row">
            <button class="btn warn" id="btnRunDiffProbe">执行差异探测</button>
          </div>
          <div class="muted" id="diffProbeMeta">尚未执行</div>
          <div style="overflow:auto; margin-top: 8px;">
            <table>
              <thead>
                <tr>
                  <th>协议</th>
                  <th>SNI</th>
                  <th>Client</th>
                  <th>Server</th>
                  <th>Strict</th>
                  <th>Relaxed</th>
                  <th>握手耗时</th>
                </tr>
              </thead>
              <tbody id="diffProbeBody"></tbody>
            </table>
          </div>
        </div>

        <div class="section split">
          <div>
            <h2>Stage Metrics 原始视图</h2>
            <pre id="stageMetricsPre">{}</pre>
          </div>
          <div>
            <h2>Adapter Metrics 原始视图</h2>
            <pre id="adapterMetricsPre">{}</pre>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-actions">
        <div class="section">
          <h2>动作控制</h2>
          <div class="action-row">
            <button class="btn" data-action="refresh">刷新代理池</button>
            <button class="btn warn" data-rotate="all">轮换 all</button>
            <button class="btn soft" data-rotate="strict">轮换 strict</button>
            <button class="btn soft" data-rotate="relaxed">轮换 relaxed</button>
            <button class="btn soft" data-rotate="mixed">轮换 mixed</button>
            <button class="btn soft" data-rotate="mainstream">轮换 mainstream</button>
            <button class="btn soft" data-rotate="cf_mixed">轮换 cf_mixed</button>
          </div>
          <pre id="actionLog">Ready.</pre>
        </div>

        <div class="section split">
          <div>
            <h2>/list 快照</h2>
            <div class="action-row">
              <button class="btn ghost" id="btnLoadSnapshot">刷新快照</button>
            </div>
            <pre id="snapshotPre">{}</pre>
          </div>
          <div>
            <h2>主流端口自检</h2>
            <div class="muted">该页面只能读取管理端状态，真实连通性请用客户端走 17290 验证。</div>
            <div class="chips" id="healthHints" style="margin-top:8px;"></div>
          </div>
        </div>
      </section>

      <section class="tab" id="tab-config">
        <div class="section">
          <h2>运行配置</h2>
          <pre id="configPre">{}</pre>
        </div>
      </section>
    </main>
  </div>

  <script>
    const state = {
      overview: null,
      proxies: [],
      metrics: null,
      sortKey: 'pool',
      sortAsc: true,
      page: 1,
      pageSize: 50,
      autoTimer: null,
      activeTab: 'overview'
    };

    const $ = (s) => document.querySelector(s);

    function escapeHTML(raw) {
      return String(raw ?? '').replace(/[&<>"]/g, (ch) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[ch]));
    }

    async function requestJSON(url, opts) {
      const resp = await fetch(url, opts);
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(`${url} => ${resp.status} ${text}`);
      }
      return resp.json();
    }

    function switchTab(tab) {
      state.activeTab = tab;
      document.querySelectorAll('.nav-btn').forEach((btn) => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      document.querySelectorAll('.tab').forEach((el) => {
        el.classList.toggle('active', el.id === `tab-${tab}`);
      });
      const map = {
        overview: '总览仪表盘',
        proxies: '代理列表',
        diagnostics: '诊断中心',
        actions: '手动操作',
        config: '运行配置'
      };
      $('#pageTitle').textContent = map[tab] || '管理台';
    }

    function renderOverview(ov) {
      const cards = [
        ['Strict 可用', ov?.strict?.available ?? 0, '严格池'],
        ['Relaxed 可用', ov?.relaxed?.available ?? 0, '宽松池'],
        ['Mixed 可用', ov?.mixed?.available ?? 0, 'HTTP/SOCKS'],
        ['Mainstream 可用', ov?.mainstream?.available ?? 0, '主流协议池'],
        ['All Healthy', ov?.all_healthy ?? 0, '总健康节点'],
        ['高优告警', ov?.high_priority_alert ? 'ON' : 'OFF', ov?.high_priority_alert ? '需要立即关注' : '暂无'],
        ['最后健康检查', ov?.last_health_check_time ? new Date(ov.last_health_check_time).toLocaleString() : '-', '检测时间戳'],
        ['更新状态', ov?.last_update_status ?? '-', '状态摘要']
      ];

      $('#overviewCards').innerHTML = cards.map(([label, value, sub]) => `
        <div class="card">
          <div class="label">${escapeHTML(label)}</div>
          <div class="value">${escapeHTML(value)}</div>
          <div class="sub">${escapeHTML(sub)}</div>
        </div>
      `).join('');

      const protocolCounts = ov?.protocol_healthy_counts || {};
      const protocolRows = Object.entries(protocolCounts).sort((a, b) => b[1] - a[1]);
      $('#protocolChips').innerHTML = protocolRows.length
        ? protocolRows.map(([k, v]) => `<span class="chip"><strong>${escapeHTML(k)}</strong>: ${Number(v) || 0}</span>`).join('')
        : '<span class="muted">暂无协议健康计数</span>';

      const sloViolations = ov?.protocol_slo_violations || {};
      const sloRows = Object.entries(sloViolations);
      if (!sloRows.length) {
        $('#sloText').innerHTML = '<span class="chip ok">SLO 状态正常</span>';
      } else {
        $('#sloText').innerHTML = sloRows
          .map(([k, v]) => `<span class="chip warn">${escapeHTML(k)} 缺口 ${Number(v) || 0}</span>`)
          .join(' ');
      }

      const funnel = ov?.mixed_stage_funnel_by_proto || {};
      const protocols = Object.keys(funnel).sort();
      if (!protocols.length) {
        $('#funnelBox').innerHTML = '<div class="muted">暂无漏斗数据，执行一次 refresh 后查看。</div>';
      } else {
        $('#funnelBox').innerHTML = protocols.map((proto) => {
          const row = funnel[proto] || {};
          const input = Math.max(0, Number(row.input || 0));
          const s1 = Math.max(0, Number(row.stage1 || 0));
          const s2 = Math.max(0, Number(row.stage2 || 0));
          const s1p = Math.max(0, Number(row.stage1_pass || 0));
          const s2p = Math.max(0, Number(row.stage2_pass || 0));
          const base = Math.max(1, input);
          const width = 280;
          const wInput = Math.max(4, Math.round(width * input / base));
          const wS1 = Math.max(4, Math.round(width * s1 / base));
          const wS2 = Math.max(4, Math.round(width * s2 / base));
          return `
            <div class="funnel-row">
              <div class="funnel-head"><span>${escapeHTML(proto)}</span><span>input=${input}</span></div>
              <div class="funnel-bars">
                <div class="bar input" style="width:${wInput}px" title="input=${input}"></div>
                <div class="bar s1" style="width:${wS1}px" title="stage1=${s1}"></div>
                <div class="bar s2" style="width:${wS2}px" title="stage2=${s2}"></div>
              </div>
              <div class="funnel-meta">stage1 ${s1p}/${s1 || 0} | stage2 ${s2p}/${s2 || 0}</div>
            </div>
          `;
        }).join('');
      }

      $('#syncLabel').textContent = `最近同步: ${ov?.last_update_time ? new Date(ov.last_update_time).toLocaleString() : '-'}`;

      const hints = [];
      if (ov?.mainstream?.available > 0) {
        hints.push('<span class="chip ok">mainstream 池可用</span>');
      } else {
        hints.push('<span class="chip warn">mainstream 池为空</span>');
      }
      if (ov?.high_priority_alert) {
        hints.push('<span class="chip warn">高优告警触发</span>');
      }
      $('#healthHints').innerHTML = hints.join(' ');
    }

    function getFilteredProxies() {
      const q = ($('#fSearch').value || '').trim().toLowerCase();
      const pool = $('#fPool').value;
      const protocol = $('#fProto').value;
      const current = $('#fCurrent').value;

      const filtered = state.proxies.filter((x) => {
        if (q && !String(x.address || '').toLowerCase().includes(q)) return false;
        if (pool && x.pool !== pool) return false;
        if (protocol && x.protocol !== protocol) return false;
        if (current === 'current' && !x.current) return false;
        if (current === 'non_current' && x.current) return false;
        return true;
      });

      filtered.sort((a, b) => {
        let ka = a[state.sortKey];
        let kb = b[state.sortKey];
        if (state.sortKey === 'current') {
          ka = a.current ? 1 : 0;
          kb = b.current ? 1 : 0;
        }
        if (typeof ka === 'number' && typeof kb === 'number') {
          return state.sortAsc ? ka - kb : kb - ka;
        }
        return state.sortAsc
          ? String(ka ?? '').localeCompare(String(kb ?? ''))
          : String(kb ?? '').localeCompare(String(ka ?? ''));
      });

      return filtered;
    }

    function renderProxyTable() {
      state.pageSize = Number($('#fPageSize').value || 50);
      const rows = getFilteredProxies();
      const total = rows.length;
      const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
      state.page = Math.min(Math.max(1, state.page), totalPages);

      const start = (state.page - 1) * state.pageSize;
      const pageRows = rows.slice(start, start + state.pageSize);

      $('#proxyTbody').innerHTML = pageRows.length
        ? pageRows.map((x) => `
            <tr>
              <td>${escapeHTML(x.address || '-')}</td>
              <td><span class="tag">${escapeHTML(x.protocol || 'unknown')}</span></td>
              <td>${escapeHTML(x.pool || '-')}</td>
              <td>${Number(x.latency_ms || 0)}</td>
              <td>${x.current ? '<span class="yes">YES</span>' : '<span class="no">NO</span>'}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="5" class="muted">无匹配代理</td></tr>';

      $('#proxySummary').textContent = `共 ${total} 条，当前第 ${state.page} 页`;
      $('#pageInfo').textContent = `${state.page} / ${totalPages}`;
      $('#prevPage').disabled = state.page <= 1;
      $('#nextPage').disabled = state.page >= totalPages;
    }

    function renderMetrics(metrics) {
      const errCodes = metrics?.error_code_counts || {};
      const codeRows = Object.entries(errCodes).sort((a, b) => b[1] - a[1]);
      $('#errorCodeChips').innerHTML = codeRows.length
        ? codeRows.slice(0, 80).map(([k, v]) => `<span class="chip"><strong>${escapeHTML(k)}</strong>: ${Number(v) || 0}</span>`).join('')
        : '<span class="muted">暂无错误码数据</span>';

      $('#stageMetricsPre').textContent = JSON.stringify(metrics?.stage_metrics || {}, null, 2);
      const adapterOnly = { ...metrics };
      delete adapterOnly.error_code_counts;
      delete adapterOnly.stage_metrics;
      $('#adapterMetricsPre').textContent = JSON.stringify(adapterOnly, null, 2);
    }

    function renderDiffProbe(report) {
      const rows = (report?.client_ok_server_fail || []).slice(0, 80);
      $('#diffProbeMeta').textContent = report
        ? `生成时间: ${new Date(report.generated_at).toLocaleString()} | target=${report.target_url} | 差异条目=${(report.client_ok_server_fail || []).length}`
        : '尚未执行';

      $('#diffProbeBody').innerHTML = rows.length
        ? rows.map((r) => `
            <tr>
              <td>${escapeHTML(r.protocol || '-')}</td>
              <td>${escapeHTML(r.sni || '-')}</td>
              <td>${r.client_success ? '<span class="yes">OK</span>' : '<span class="no">FAIL</span>'}</td>
              <td>${r.server_success ? '<span class="yes">OK</span>' : '<span class="no">FAIL</span>'}</td>
              <td>${r.strict_success ? '<span class="yes">OK</span>' : '<span class="no">FAIL</span>'}</td>
              <td>${r.relaxed_success ? '<span class="yes">OK</span>' : '<span class="no">FAIL</span>'}</td>
              <td>${escapeHTML(r.handshake_latency || '-')}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="7" class="muted">暂无差异条目</td></tr>';
    }

    async function loadOverview() {
      const ov = await requestJSON('/api/overview');
      state.overview = ov;
      renderOverview(ov);
    }

    async function loadProxies() {
      const data = await requestJSON('/api/proxies');
      state.proxies = data.items || [];

      const protocols = [...new Set(state.proxies.map((x) => x.protocol).filter(Boolean))].sort();
      const current = $('#fProto').value;
      $('#fProto').innerHTML = '<option value="">全部协议</option>' + protocols.map((p) => `<option value="${escapeHTML(p)}">${escapeHTML(p)}</option>`).join('');
      if (protocols.includes(current)) $('#fProto').value = current;

      renderProxyTable();
    }

    async function loadConfig() {
      const cfg = await requestJSON('/api/config');
      $('#configPre').textContent = JSON.stringify(cfg, null, 2);
    }

    async function loadMetrics() {
      const metrics = await requestJSON('/metrics');
      state.metrics = metrics;
      renderMetrics(metrics);
    }

    async function loadSnapshot() {
      const snapshot = await requestJSON('/list');
      $('#snapshotPre').textContent = JSON.stringify(snapshot, null, 2);
    }

    async function runDiffProbe() {
      $('#diffProbeMeta').textContent = '差异探测执行中，请稍候...';
      const report = await requestJSON('/api/diagnostics/diff-probe', { method: 'POST' });
      renderDiffProbe(report);
      return report;
    }

    function logAction(msg, data) {
      const lines = [
        `[${new Date().toLocaleString()}] ${msg}`,
        data ? JSON.stringify(data, null, 2) : ''
      ].filter(Boolean);
      $('#actionLog').textContent = lines.join('\n');
    }

    async function callAction(path, payload) {
      const resp = await requestJSON(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload || {})
      });
      return resp;
    }

    async function refreshAll() {
      try {
        await Promise.all([loadOverview(), loadProxies(), loadConfig(), loadMetrics(), loadSnapshot()]);
      } catch (err) {
        logAction(`刷新失败: ${err.message}`);
      }
    }

    function resetAutoRefresh() {
      if (state.autoTimer) {
        clearInterval(state.autoTimer);
        state.autoTimer = null;
      }
      if (!$('#autoRefresh').checked) return;
      const sec = Number($('#autoInterval').value || 30);
      state.autoTimer = setInterval(() => {
        refreshAll();
      }, sec * 1000);
    }

    function bindEvents() {
      document.querySelectorAll('.nav-btn').forEach((btn) => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      $('#btnReloadAll').addEventListener('click', refreshAll);
      $('#btnLoadMetrics').addEventListener('click', async () => {
        try {
          await loadMetrics();
          logAction('metrics 刷新成功');
        } catch (err) {
          logAction(`metrics 刷新失败: ${err.message}`);
        }
      });

      $('#btnRunDiffProbe').addEventListener('click', async () => {
        try {
          const report = await runDiffProbe();
          logAction('diff-probe 执行完成', {
            generated_at: report.generated_at,
            diff_count: (report.client_ok_server_fail || []).length
          });
        } catch (err) {
          logAction(`diff-probe 执行失败: ${err.message}`);
        }
      });

      $('#btnLoadSnapshot').addEventListener('click', async () => {
        try {
          await loadSnapshot();
          logAction('list 快照刷新成功');
        } catch (err) {
          logAction(`list 快照刷新失败: ${err.message}`);
        }
      });

      document.querySelectorAll('[data-action="refresh"]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          try {
            const resp = await callAction('/api/actions/refresh');
            logAction('refresh 已触发', resp);
            setTimeout(refreshAll, 1200);
          } catch (err) {
            logAction(`refresh 失败: ${err.message}`);
          }
        });
      });

      document.querySelectorAll('[data-rotate]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const pool = btn.dataset.rotate;
          try {
            const resp = await callAction('/api/actions/rotate', { pool });
            logAction(`rotate ${pool} 完成`, resp);
            setTimeout(refreshAll, 600);
          } catch (err) {
            logAction(`rotate ${pool} 失败: ${err.message}`);
          }
        });
      });

      ['#fSearch', '#fPool', '#fProto', '#fCurrent', '#fPageSize'].forEach((selector) => {
        $(selector).addEventListener('input', () => {
          state.page = 1;
          renderProxyTable();
        });
        $(selector).addEventListener('change', () => {
          state.page = 1;
          renderProxyTable();
        });
      });

      $('#prevPage').addEventListener('click', () => {
        state.page = Math.max(1, state.page - 1);
        renderProxyTable();
      });

      $('#nextPage').addEventListener('click', () => {
        state.page += 1;
        renderProxyTable();
      });

      document.querySelectorAll('th[data-sort]').forEach((th) => {
        th.addEventListener('click', () => {
          const key = th.dataset.sort;
          if (state.sortKey === key) {
            state.sortAsc = !state.sortAsc;
          } else {
            state.sortKey = key;
            state.sortAsc = true;
          }
          renderProxyTable();
        });
      });

      $('#autoRefresh').addEventListener('change', resetAutoRefresh);
      $('#autoInterval').addEventListener('change', resetAutoRefresh);
    }

    async function boot() {
      bindEvents();
      renderDiffProbe(null);
      await refreshAll();
      resetAutoRefresh();
    }

    boot().catch((err) => {
      logAction(`页面初始化失败: ${err.message}`);
    });
  </script>
</body>
</html>
